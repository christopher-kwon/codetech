<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="Admin">
	<!-- 유저 리스트 쿼리 -->
	<select id="getUsersSearchList" parameterType="map" resultType="upi">
		SELECT *
		FROM (SELECT ROWNUM RNUM, U.USER_ID, U.USER_EMAIL, U.CREATED_AT, U.UPDATED_AT, U.USER_NAME, U.USER_TEL, U.POINT, U.USER_ADDRESS, U.USER_STATUS
			  FROM (SELECT USERS.*, USER_INFO.USER_NAME, USER_INFO.USER_TEL, USER_INFO.USER_ADDRESS, USER_INFO.POINT
			 	    FROM USERS, USER_INFO
			  		WHERE USERS.USER_ID = USER_INFO.USER_ID AND USERS.ROLE_ID = 5  
			  		<if test="search_field == null and check_state == null">
				    	AND USERS.USER_STATUS = 1
			   		</if>
			   		
			  		<if test="search_field != null and check_state != null">
			  		AND USERS.USER_STATUS =
			  		<choose>
			  			<when test="check_state == 0">1</when>
			  			<when test="check_state == 1">2</when>
			  			<when test="check_state == 2">3</when>
			  			<when test="check_state == 3">4</when>
			  		</choose>
			  		
			  		AND
			  		<choose>
			  			<!-- user_info 테이블 참조 -->
			  			<when test="search_field == 'user_email'">USERS.USER_EMAIL</when>
			  			<when test="search_field == 'user_name'">USER_INFO.USER_NAME</when>
			  			<when test="search_field == 'user_tel'">USER_INFO.USER_TEL</when>
			  		</choose>
			  		LIKE #{search_word}
			  		</if>
			  		ORDER BY USER_INFO.USER_NAME
			  ) U
		)
		WHERE RNUM &gt;=#{start} and RNUM &lt;=#{end}	
	</select>
	
	<select id="searchCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT U.USER_ID, U.USER_EMAIL, U.CREATED_AT, U.UPDATED_AT,
			 		 U.USER_NAME, U.USER_TEL, U.POINT, U.USER_ADDRESS, U.USER_STATUS
			  FROM (SELECT USERS.*, USER_INFO.USER_NAME, USER_INFO.USER_TEL, USER_INFO.USER_ADDRESS, USER_INFO.POINT
			 	    FROM USERS, USER_INFO
			  		WHERE USERS.USER_ID = USER_INFO.USER_ID AND USERS.ROLE_ID = 5
			  		<if test="search_field == null and check_state == null">
				    	AND USERS.USER_STATUS = 1 
			   		</if>
			   		
			  		<if test="search_field != null and check_state != null">
			  			AND USERS.USER_STATUS =
			  		<choose>
			  			<when test="check_state == 0">1</when>
			  			<when test="check_state == 1">2</when>
			  			<when test="check_state == 2">3</when>
			  			<when test="check_state == 3">4</when>
			  		</choose> 		
			  		
			  		AND
			  		<choose>
			  			<!-- user_info 테이블 참조 -->
			  			<when test="search_field == 'user_email'">USERS.USER_EMAIL</when>
			  			<when test="search_field == 'user_name'">USER_INFO.USER_NAME</when>
			  			<when test="search_field == 'user_tel'">USER_INFO.USER_TEL</when>
			  		</choose>
			  		LIKE #{search_word}
			  		</if>
			  		ORDER BY USER_INFO.USER_NAME
			  ) U
		)
	</select> <!-- 유저 리스트 쿼리 End -->
	
	<!-- 회원 정지 -->
	<update id="susp" parameterType="String">
		UPDATE USERS
		SET USER_STATUS = 3
		WHERE USER_ID = #{user_id}
	</update>
	
	<!-- 정지 해제 -->
	<update id="reac" parameterType="String">
		UPDATE USERS
		SET USER_STATUS = 1
		WHERE USER_ID = #{user_id}
	</update>
	
	<!-- 탈퇴 취소 -->
	<update id="inac" parameterType="String">
		UPDATE USERS
		SET USER_STATUS = 1
		WHERE USER_ID = #{user_id}
	</update>
	
	<!-- 강제 탈퇴 -->
	<update id="banned" parameterType="String">
		UPDATE USERS
		SET USER_STATUS = 4
		WHERE USER_ID = #{user_id}
	</update>
	
	<select id="count" resultType="int">
		SELECT COUNT(*) FROM NOTICE_BOARD
	</select>
</mapper>
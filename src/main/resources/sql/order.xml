<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Orders">
	<select id="list" resultType="menu" parameterType="int">
		select *
		from
		orders
		where store_id = #{store_id}
	</select>

	<select id="ordered" resultType="order" parameterType="map">
		select * from (
select row_number() over(order by updated_at desc) row_num, bb.* from (
		<include refid="forOrdered" />
				) bb ) where row_num &gt;= #{start}
        and row_num &lt;= #{end}
	</select>
	
		

	<select id="ordered_stores" resultType="store"
		parameterType="map">
				select * from (
select row_number() over(order by updated_at desc) row_num, bb.* from (

		select store_name, s.store_id, s.updated_at from stores s join
		(
		<include refid="forOrdered" />
		) b
		on s.store_id = b.store_id
		
		) bb ) where row_num &gt;= #{start}
        and row_num &lt;= #{end}
	</select>


	
		<sql id="forOrdered">
		select *
		from orders
		where order_user = #{user_id} 
	</sql>
	
	

	<select id="ordered_details" resultType="order-detail"
		parameterType="map">
				select * from (
select row_number() over(order by updated_at desc) row_num, bb.* from (
		select b.updated_at, detail_id, menu_quantity, detail_total_price, menu_id
		from
		order_details a
		join (
		<include refid="forOrdered" />
		) b
		on a.order_id = b.order_id
						) bb ) where row_num &gt;= #{start}
        and row_num &lt;= #{end}
	</select>

	<select id="ordered_menu" resultType="menu" parameterType="map">
	select * from (
select row_number() over(order by updated_at desc) row_num, bb.* from (
		select p.updated_at, m.menu_id, m.menu_name from menus m join (
		select  b.updated_at, detail_id,
		menu_quantity, detail_total_price, menu_id
		from
		order_details a
		join (
		<include refid="forOrdered" />
		) b
		on a.order_id = b.order_id ) p on m.menu_id = p.menu_id
		) bb ) where row_num &gt;= #{start}
        and row_num &lt;= #{end}
	</select>

	<select id="orderCount" resultType="int">
		select count(*) from orders where order_user = #{user_id}
	</select>

</mapper>